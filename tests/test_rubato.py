#!/usr/bin/env python

"""Tests for `rubato` package."""
import pytest
from rubato.rubato import MultiScaleModel, MultiImageModel
import numpy.testing as npt
import numpy as np
from lenstronomy.LensModel.lens_model_extensions import LensModelExtensions
from lenstronomy.LensModel.lens_model import LensModel
from lenstronomy.Cosmo.background import Background
from time import time


class TestRubato(object):
    """Tests for `rubato` package."""

    def setup(self):

        self.zlens, self.zsource = 0.5, 1.5
        # cdm = CDM(self.zlens, self.zsource, log_mlow=7.4)
        # self.lens_model_list_halos, self.redshift_list_halos, self.kwargs_halos, _ = cdm.lensing_quantities()
        self.lens_model_list_halos = ['TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'TNFW', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CONVERGENCE', 'CNFW']
        self.redshift_list_halos = [0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 ,
       0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.5 , 0.19, 0.19, 0.23,
       0.23, 0.23, 0.25, 0.25, 0.29, 0.29, 0.31, 0.33, 0.33, 0.33, 0.35,
       0.35, 0.35, 0.37, 0.37, 0.37, 0.37, 0.39, 0.39, 0.39, 0.39, 0.39,
       0.41, 0.41, 0.41, 0.41, 0.41, 0.43, 0.43, 0.45, 0.45, 0.47, 0.47,
       0.47, 0.47, 0.47, 0.47, 0.47, 0.49, 0.49, 0.5 , 0.5 , 0.5 , 0.52,
       0.52, 0.52, 0.52, 0.52, 0.52, 0.54, 0.54, 0.54, 0.56, 0.56, 0.56,
       0.56, 0.56, 0.58, 0.58, 0.58, 0.58, 0.58, 0.58, 0.58, 0.6 , 0.6 ,
       0.6 , 0.6 , 0.6 , 0.62, 0.62, 0.64, 0.64, 0.64, 0.64, 0.64, 0.64,
       0.66, 0.68, 0.7 , 0.7 , 0.7 , 0.72, 0.74, 0.74, 0.76, 0.76, 0.76,
       0.78, 0.78, 0.8 , 0.8 , 0.82, 0.84, 0.84, 0.84, 0.84, 0.86, 0.86,
       0.88, 0.9 , 0.92, 0.92, 0.92, 0.92, 0.94, 0.94, 0.96, 0.98, 0.98,
       1.  , 1.  , 1.  , 1.  , 1.  , 1.02, 1.02, 1.02, 1.04, 1.1 , 1.14,
       1.14, 1.16, 1.18, 1.2 , 1.22, 1.24, 1.24, 1.24, 1.26, 1.26, 1.28,
       1.3 , 1.32, 1.32, 1.34, 1.34, 1.34, 1.34, 1.34, 1.36, 1.38, 1.38,
       1.4 , 1.4 , 1.44, 1.44, 1.46, 0.5 , 0.5 , 0.5 , 0.01, 0.05, 0.09,
       0.13, 0.17, 0.21, 0.25, 0.29, 0.33, 0.37, 0.41, 0.45, 0.49, 0.52,
       0.56, 0.6 , 0.64, 0.68, 0.72, 0.76, 0.8 , 0.84, 0.88, 0.92, 0.96,
       1.  , 1.04, 1.08, 1.12, 1.16, 1.2 , 1.24, 1.28, 1.32, 1.36, 1.4 ,
       1.44, 1.48, 0.5 ]
        self.kwargs_halos = [{'alpha_Rs': 0.000355179, 'Rs': 0.0738537464, 'center_x': -0.9102, 'center_y': 1.5325, 'r_trunc': 0.13723210053340426}, {'alpha_Rs': 0.0004562523, 'Rs': 0.1513934123, 'center_x': 1.0816, 'center_y': 1.7153, 'r_trunc': 0.2665408696272355}, {'alpha_Rs': 0.0019324995, 'Rs': 0.543248247, 'center_x': -0.2791, 'center_y': 0.5693, 'r_trunc': 0.9503243728623849}, {'alpha_Rs': 0.0012376699, 'Rs': 0.2245945211, 'center_x': 0.7145, 'center_y': -1.7376, 'r_trunc': 1.3515618769623614}, {'alpha_Rs': 0.0002538157, 'Rs': 0.1255577132, 'center_x': -1.9663, 'center_y': 1.8576, 'r_trunc': 0.18350435614051053}, {'alpha_Rs': 0.000248753, 'Rs': 0.2055686832, 'center_x': 1.6053, 'center_y': 0.4896, 'r_trunc': 0.3671671789098126}, {'alpha_Rs': 0.0003163183, 'Rs': 0.0793126703, 'center_x': -0.3187, 'center_y': 2.9632, 'r_trunc': 0.2216948136792524}, {'alpha_Rs': 0.0036221919, 'Rs': 0.3780395946, 'center_x': -1.4879, 'center_y': -0.0461, 'r_trunc': 0.5226229417542347}, {'alpha_Rs': 0.0002145761, 'Rs': 0.1972744274, 'center_x': -0.6132, 'center_y': -1.4538, 'r_trunc': 0.8205402038821793}, {'alpha_Rs': 0.0003188417, 'Rs': 0.0868064195, 'center_x': -1.3116, 'center_y': 2.3009, 'r_trunc': 0.38333077504654145}, {'alpha_Rs': 0.0003831978, 'Rs': 0.0850628497, 'center_x': -1.3965, 'center_y': -2.1246, 'r_trunc': 0.29284633000661786}, {'alpha_Rs': 0.0005000772, 'Rs': 0.2968849811, 'center_x': 2.0777, 'center_y': 0.7903, 'r_trunc': 0.34022785201526434}, {'alpha_Rs': 0.0008204174, 'Rs': 0.4082315615, 'center_x': -1.1038, 'center_y': 1.5544, 'r_trunc': 1.456149851964725}, {'alpha_Rs': 0.0003281562, 'Rs': 0.1370392045, 'center_x': 0.1366, 'center_y': 1.779, 'r_trunc': 0.6237246509231861}, {'alpha_Rs': 0.0005064317, 'Rs': 0.0980599192, 'center_x': 1.7469, 'center_y': -1.9766, 'r_trunc': 0.21630694830034275}, {'alpha_Rs': 0.0004038709, 'Rs': 0.0767531554, 'center_x': -0.9319, 'center_y': -0.8859, 'r_trunc': 0.159892828450583}, {'alpha_Rs': 0.0002790143, 'Rs': 0.2103269589, 'center_x': 1.2414, 'center_y': 1.917, 'r_trunc': 0.6956685003945089}, {'alpha_Rs': 0.0002982337, 'Rs': 0.1086676633, 'center_x': 0.03, 'center_y': -2.6016, 'r_trunc': 0.17035162595081937}, {'alpha_Rs': 0.0002251665, 'Rs': 0.0925037823, 'center_x': -0.8885, 'center_y': -1.5135, 'r_trunc': 0.34165405167438756}, {'alpha_Rs': 0.0002552781, 'Rs': 0.1093307251, 'center_x': 0.4343, 'center_y': -2.3446, 'r_trunc': 0.16734076000378165}, {'alpha_Rs': 0.0001885545, 'Rs': 0.2074662559, 'center_x': -1.1554, 'center_y': -0.3139, 'r_trunc': 0.31946872364358314}, {'alpha_Rs': 0.0003489887, 'Rs': 0.0928325098, 'center_x': 1.0079, 'center_y': 2.4006, 'r_trunc': 0.24704947428588594}, {'alpha_Rs': 0.0004219543, 'Rs': 0.0956332712, 'center_x': 1.221, 'center_y': -0.8998, 'r_trunc': 0.2484756739450091}, {'alpha_Rs': 0.0002263808, 'Rs': 0.13544901, 'center_x': 0.9658, 'center_y': 1.2644, 'r_trunc': 0.15450496307167338}, {'alpha_Rs': 0.0011686026, 'Rs': 0.601883877, 'center_x': -1.8659, 'center_y': 1.3922, 'r_trunc': 0.7354436242211654}, {'alpha_Rs': 0.0002033764, 'Rs': 0.2257882543, 'center_x': -1.102, 'center_y': -2.4603, 'r_trunc': 0.6692045733863351}, {'alpha_Rs': 0.0003739103, 'Rs': 0.096807214, 'center_x': -0.3764, 'center_y': 2.7384, 'r_trunc': 0.3522713158034153}, {'alpha_Rs': 0.0002952049, 'Rs': 0.1015590377, 'center_x': 1.5719, 'center_y': 1.1778, 'r_trunc': 0.15751582901871114}, {'alpha_Rs': 0.0007768627, 'Rs': 0.1335297743, 'center_x': -0.0496, 'center_y': 0.8727, 'r_trunc': 0.4557500244042386}, {'alpha_Rs': 0.0002363017, 'Rs': 0.1228197093, 'center_x': 1.4154, 'center_y': 2.2133, 'r_trunc': 0.53514180542876}, {'alpha_Rs': 0.0049333475, 'Rs': 0.4160006769, 'center_x': -2.9016, 'center_y': -0.3651, 'r_trunc': 0.8802821229365596}, {'alpha_Rs': 0.0003547375, 'Rs': 0.1238663931, 'center_x': -0.9522, 'center_y': 2.3594, 'r_trunc': 0.23468907724015212}, {'alpha_Rs': 0.0009204117, 'Rs': 0.5324541065, 'center_x': -0.9046, 'center_y': 0.5788, 'r_trunc': 0.22660727917178763}, {'alpha_Rs': 0.0001979535, 'Rs': 0.2874164815, 'center_x': -2.5257, 'center_y': -0.1013, 'r_trunc': 0.1774826242464351}, {'alpha_Rs': 0.0003440738, 'Rs': 0.3196099856, 'center_x': 2.2179, 'center_y': 0.7919, 'r_trunc': 0.30314666087806275}, {'alpha_Rs': 0.000329811, 'Rs': 0.0583948497, 'center_x': 0.1092, 'center_y': 2.9016, 'r_trunc': 0.1730455586402742}, {'alpha_Rs': 0.0002301757, 'Rs': 0.127491528, 'center_x': -1.2106, 'center_y': -1.4346, 'r_trunc': 0.13612283413186405}, {'alpha_Rs': 0.0006425536, 'Rs': 0.2017028152, 'center_x': -0.4926, 'center_y': 0.8711, 'r_trunc': 0.3701780448568503}, {'alpha_Rs': 0.000333546, 'Rs': 0.0848585043, 'center_x': -0.5048, 'center_y': -0.411, 'r_trunc': 0.18033502356468134}, {'alpha_Rs': 0.0022861348, 'Rs': 0.3572289769, 'center_x': -2.0569, 'center_y': 1.1019, 'r_trunc': 0.4598701567528166}, {'alpha_Rs': 0.0002828504, 'Rs': 0.219883458, 'center_x': 0.5382, 'center_y': 0.4543, 'r_trunc': 0.37303044417509656}, {'alpha_Rs': 0.0005099039, 'Rs': 0.1203510902, 'center_x': -2.5095, 'center_y': -0.5447, 'r_trunc': 0.221219413792878}, {'alpha_Rs': 0.0005941409, 'Rs': 0.284765397, 'center_x': 1.2799, 'center_y': -2.4987, 'r_trunc': 0.294272529665741}, {'alpha_Rs': 0.0006774084, 'Rs': 0.1834447247, 'center_x': -0.9419, 'center_y': -2.0345, 'r_trunc': 0.33024445440140243}, {'alpha_Rs': 0.0001902248, 'Rs': 0.146933353, 'center_x': -2.6241, 'center_y': 0.0422, 'r_trunc': 0.1576742956475026}, {'alpha_Rs': 0.0002893841, 'Rs': 0.0642846853, 'center_x': -2.6595, 'center_y': 0.9194, 'r_trunc': 0.18096889007984718}, {'alpha_Rs': 0.0007699306, 'Rs': 0.1872257696, 'center_x': 1.9806, 'center_y': -0.3831, 'r_trunc': 0.3807953089858781}, {'alpha_Rs': 0.0007869224, 'Rs': 0.4410889614, 'center_x': 0.2451, 'center_y': 1.5614, 'r_trunc': 0.3294521212574451}, {'alpha_Rs': 0.000362425, 'Rs': 0.1338116147, 'center_x': -1.0037, 'center_y': -1.6913, 'r_trunc': 0.6603304421740133}, {'alpha_Rs': 0.0003656789, 'Rs': 0.1352219614, 'center_x': -0.8544, 'center_y': -1.583, 'r_trunc': 0.32485658902249276}, {'alpha_Rs': 0.0003003333, 'Rs': 0.0630598595, 'center_x': -1.3876, 'center_y': -0.337, 'r_trunc': 0.25655747201337353}, {'alpha_Rs': 0.0002507934, 'Rs': 0.0939347823, 'center_x': -0.6212, 'center_y': 1.1383, 'r_trunc': 0.26559006985448674}, {'alpha_Rs': 0.0003148501, 'Rs': 0.1031133725, 'center_x': 0.3927, 'center_y': 1.4715, 'r_trunc': 0.12122697102546681}, {'alpha_Rs': 0.0001957202, 'Rs': 0.143555101, 'center_x': -0.8943, 'center_y': -0.0411, 'r_trunc': 0.401079037471185}, {'alpha_Rs': 0.0009604673, 'Rs': 0.1733869147, 'center_x': 0.0904, 'center_y': -2.3343, 'r_trunc': 0.3278674549695305}, {'alpha_Rs': 0.0010181835, 'Rs': 0.15483521, 'center_x': 2.6318, 'center_y': 0.4987, 'r_trunc': 1.3634468741217207}, {'alpha_Rs': 0.0003358636, 'Rs': 0.083414381, 'center_x': -0.6055, 'center_y': 1.3855, 'r_trunc': 0.750814887213937}, {'alpha_Rs': 0.0002527996, 'Rs': 0.0639667605, 'center_x': 0.8472, 'center_y': 0.0494, 'r_trunc': 0.09444611075971009}, {'alpha_Rs': 0.000255908, 'Rs': 0.1123615341, 'center_x': -0.9193, 'center_y': -1.009, 'r_trunc': 0.13564743424548967}, {'alpha_Rs': 0.0001963431, 'Rs': 0.3088591482, 'center_x': 0.7905, 'center_y': 0.3718, 'r_trunc': 1.0010336940756521}, {'alpha_Rs': 0.0005502464, 'Rs': 0.0928628938, 'center_x': 0.8612, 'center_y': -0.8557, 'r_trunc': 0.6089872544455803}, {'alpha_Rs': 0.0002784011, 'Rs': 0.1221082672, 'center_x': 2.5824, 'center_y': 0.8877, 'r_trunc': 0.21551461515638545}, {'alpha_Rs': 0.0002376893, 'Rs': 0.0745464504, 'center_x': 1.9851, 'center_y': -0.4351, 'r_trunc': 0.12709023629075084}, {'alpha_Rs': 0.0004819991, 'Rs': 0.3524602335, 'center_x': -0.246, 'center_y': 1.1565, 'r_trunc': 0.19269542061041522}, {'alpha_Rs': 0.0006276865, 'Rs': 0.2379751517, 'center_x': -0.6904, 'center_y': 2.0179, 'r_trunc': 0.5825233274374065}, {'alpha_Rs': 0.0005569141, 'Rs': 0.0745398599, 'center_x': 0.128, 'center_y': 0.0977, 'r_trunc': 0.11869150496480345}, {'alpha_Rs': 0.0002045363, 'Rs': 0.1220779904, 'center_x': -2.3411, 'center_y': 0.0547, 'r_trunc': 0.23484754386894355}, {'alpha_Rs': 0.0001763264, 'Rs': 0.2121193241, 'center_x': -0.9527, 'center_y': -1.769, 'r_trunc': 0.2125037492093477}, {'alpha_Rs': 0.0008164736, 'Rs': 0.1667909283, 'center_x': 0.1661, 'center_y': -2.7219, 'r_trunc': 0.8295728017232925}, {'alpha_Rs': 0.0002183089, 'Rs': 0.096522908, 'center_x': 0.4041, 'center_y': 0.1605, 'r_trunc': 0.09064291166871505}, {'alpha_Rs': 0.0002597903, 'Rs': 0.2188008677, 'center_x': -1.162, 'center_y': 2.4937, 'r_trunc': 0.8650693265725795}, {'alpha_Rs': 0.0002179821, 'Rs': 0.1487955879, 'center_x': 2.6389, 'center_y': 1.4219, 'r_trunc': 0.19649861970141025}, {'alpha_Rs': 0.0005687869, 'Rs': 0.369164773, 'center_x': 0.2636, 'center_y': 2.4065, 'r_trunc': 0.3695441783416844}, {'alpha_Rs': 0.0002339497, 'Rs': 0.1283163797, 'center_x': -0.2797, 'center_y': -1.4762, 'r_trunc': 0.2673332027711928}, {'alpha_Rs': 0.0004805844, 'Rs': 0.1698593617, 'center_x': 0.246, 'center_y': -1.7975, 'r_trunc': 0.2548143390966675}, {'alpha_Rs': 0.0002517919, 'Rs': 0.1324029739, 'center_x': -0.8884, 'center_y': -1.0385, 'r_trunc': 0.2579836716724967}, {'alpha_Rs': 0.0007546279, 'Rs': 0.1282045686, 'center_x': -1.7704, 'center_y': -0.0881, 'r_trunc': 0.1998264189060309}, {'alpha_Rs': 0.0003250472, 'Rs': 0.0808190683, 'center_x': 0.5799, 'center_y': -1.9745, 'r_trunc': 0.4064669028500946}, {'alpha_Rs': 0.0002376354, 'Rs': 0.175966969, 'center_x': -1.135, 'center_y': 0.0679, 'r_trunc': 0.14214456602593953}, {'alpha_Rs': 0.0004647231, 'Rs': 0.147981146, 'center_x': 0.3701, 'center_y': -2.5826, 'r_trunc': 0.5490868687624085}, {'alpha_Rs': 0.0010580032, 'Rs': 0.2797656998, 'center_x': 0.3904, 'center_y': 0.0188, 'r_trunc': 0.33040292103019386}, {'alpha_Rs': 0.0003754555, 'Rs': 0.136692812, 'center_x': -0.6669, 'center_y': -0.6006, 'r_trunc': 1.355523542682148}, {'alpha_Rs': 0.0002355664, 'Rs': 0.1440467369, 'center_x': -0.1609, 'center_y': -2.112, 'r_trunc': 0.3958496387210668}, {'alpha_Rs': 0.0002541939, 'Rs': 0.3873204795, 'center_x': -0.6135, 'center_y': -0.6457, 'r_trunc': 0.13184423515449462}, {'alpha_Rs': 0.0012608536, 'Rs': 0.3768451037, 'center_x': -0.8428, 'center_y': -0.3012, 'r_trunc': 1.0615679462739898}, {'alpha_Rs': 0.0002766575, 'Rs': 0.0593821713, 'center_x': -0.8881, 'center_y': -0.2109, 'r_trunc': 0.09301991110058695}, {'alpha_Rs': 0.000190098, 'Rs': 0.1940455655, 'center_x': 1.5505, 'center_y': -0.4974, 'r_trunc': 0.24768334080105178}, {'alpha_Rs': 0.0003083249, 'Rs': 0.2012584848, 'center_x': -2.2027, 'center_y': -1.7263, 'r_trunc': 0.48871108319286233}, {'alpha_Rs': 0.0004473436, 'Rs': 0.0889456615, 'center_x': 2.0557, 'center_y': 2.1546, 'r_trunc': 1.2143297764289571}, {'alpha_Rs': 0.0003696034, 'Rs': 0.3126483399, 'center_x': 0.3322, 'center_y': 0.0055, 'r_trunc': 0.27002713546064766}, {'alpha_Rs': 0.0003430537, 'Rs': 0.1590934489, 'center_x': 0.8311, 'center_y': -1.3557, 'r_trunc': 0.17447175829939734}, {'alpha_Rs': 0.0002607364, 'Rs': 0.2579652425, 'center_x': 1.5878, 'center_y': -1.2891, 'r_trunc': 0.17320402526906564}, {'alpha_Rs': 0.0002193574, 'Rs': 0.0874527221, 'center_x': -0.5259, 'center_y': 0.1166, 'r_trunc': 0.06497131780449855}, {'alpha_Rs': 0.0007381506, 'Rs': 0.2963161319, 'center_x': 0.3358, 'center_y': 1.3919, 'r_trunc': 0.24340474182368238}, {'alpha_Rs': 0.0003664083, 'Rs': 0.1225414445, 'center_x': -1.3714, 'center_y': -0.7752, 'r_trunc': 0.8916917202095448}, {'alpha_Rs': 0.0001991975, 'Rs': 0.1631487233, 'center_x': -1.0838, 'center_y': -2.7907, 'r_trunc': 0.18984302129216893}, {'alpha_Rs': 0.0009304834, 'Rs': 0.1101817681, 'center_x': -1.3767, 'center_y': -0.3009, 'r_trunc': 0.6742755055076618}, {'alpha_Rs': 0.0019938287, 'Rs': 0.4644858712, 'center_x': 0.0708, 'center_y': -0.6952, 'r_trunc': 2.8135749941923702}, {'alpha_Rs': 0.0001751047, 'Rs': 0.2172603117, 'center_x': -1.5539, 'center_y': -1.5415, 'r_trunc': 0.29094473046112035}, {'alpha_Rs': 0.0002193525, 'Rs': 0.0945925613, 'center_x': 1.2942, 'center_y': 0.91, 'r_trunc': 0.2638469369377807}, {'alpha_Rs': 0.0017067445, 'Rs': 0.2336235587, 'center_x': 0.0481, 'center_y': -2.9086, 'r_trunc': 1.458526851396597}, {'alpha_Rs': 0.0006106831, 'Rs': 0.2866754155, 'center_x': 1.4034, 'center_y': -2.0165, 'r_trunc': 0.40836850239559214}, {'alpha_Rs': 0.0005482943, 'Rs': 0.1533867892, 'center_x': -0.3876, 'center_y': -2.5477, 'r_trunc': 0.2511696066344639}, {'alpha_Rs': 0.0002228825, 'Rs': 0.1893573812, 'center_x': 1.0361, 'center_y': -0.6047, 'r_trunc': 0.10617264129027813}, {'alpha_Rs': 0.0003769582, 'Rs': 0.2379653823, 'center_x': -1.0573, 'center_y': -2.4312, 'r_trunc': 0.31186232546159304}, {'alpha_Rs': 0.0005446876, 'Rs': 0.3844927378, 'center_x': -0.7931, 'center_y': 0.8782, 'r_trunc': 0.4191442331534114}, {'alpha_Rs': 0.0025244316, 'Rs': 0.3499640671, 'center_x': -0.4602, 'center_y': 1.5933, 'r_trunc': 0.6196045185746082}, {'alpha_Rs': 0.0054175777, 'Rs': 0.5983339707, 'center_x': -1.1206, 'center_y': -2.2196, 'r_trunc': 9.75816172468243}, {'alpha_Rs': 0.0018434974, 'Rs': 0.1656133556, 'center_x': 1.5837, 'center_y': -0.8801, 'r_trunc': 4.863937625929385}, {'alpha_Rs': 0.0008145045, 'Rs': 0.0915219168, 'center_x': 1.948, 'center_y': 0.0304, 'r_trunc': 2.6752872735389355}, {'alpha_Rs': 0.0005271524, 'Rs': 0.0885125662, 'center_x': -0.2391, 'center_y': 0.6445, 'r_trunc': 2.242456053003194}, {'alpha_Rs': 0.0008019368, 'Rs': 0.1914408359, 'center_x': 0.735, 'center_y': 0.6408, 'r_trunc': 3.1102191201245577}, {'alpha_Rs': 0.0005183276, 'Rs': 0.1153223656, 'center_x': 1.3986, 'center_y': -0.6994, 'r_trunc': 2.2086585565026677}, {'alpha_Rs': 0.0007418961, 'Rs': 0.1799660867, 'center_x': -0.6145, 'center_y': 0.5779, 'r_trunc': 2.7874400842656675}, {'alpha_Rs': 0.0016668873, 'Rs': 0.1447946727, 'center_x': 2.5399, 'center_y': -0.3287, 'r_trunc': 3.2741839260374683}, {'alpha_Rs': 0.0004170871, 'Rs': 0.0700026075, 'center_x': -0.5274, 'center_y': 0.1991, 'r_trunc': 1.6257180938579932}, {'alpha_Rs': 0.0022428098, 'Rs': 0.2201250933, 'center_x': 0.0078, 'center_y': -0.2237, 'r_trunc': 3.8183723496853075}, {'alpha_Rs': 0.0005796001, 'Rs': 0.0510838228, 'center_x': 0.7458, 'center_y': -1.2776, 'r_trunc': 1.5589420131887226}, {'alpha_Rs': 0.0007619996, 'Rs': 0.1453984178, 'center_x': 0.2977, 'center_y': -2.4187, 'r_trunc': 2.1735549503115617}, {'alpha_Rs': 0.0003092382, 'Rs': 0.0932786269, 'center_x': 1.2338, 'center_y': -0.0539, 'r_trunc': 1.3865618815781633}, {'alpha_Rs': 0.0003174829, 'Rs': 0.0691217201, 'center_x': 2.604, 'center_y': -1.4886, 'r_trunc': 1.259935853645228}, {'alpha_Rs': 0.0006235271, 'Rs': 0.089260301, 'center_x': -1.6305, 'center_y': -1.911, 'r_trunc': 1.7356120803099004}, {'alpha_Rs': 0.0004897904, 'Rs': 0.0659725002, 'center_x': 2.4516, 'center_y': 0.0086, 'r_trunc': 1.4792994290879036}, {'alpha_Rs': 0.0004821563, 'Rs': 0.055628783, 'center_x': -2.28, 'center_y': -0.6775, 'r_trunc': 1.3578456322033738}, {'alpha_Rs': 0.0004025404, 'Rs': 0.1119866173, 'center_x': -2.2681, 'center_y': -0.6795, 'r_trunc': 1.461841725293497}, {'alpha_Rs': 0.0003324461, 'Rs': 0.0823043354, 'center_x': -1.5944, 'center_y': -1.3925, 'r_trunc': 1.2745532220965239}, {'alpha_Rs': 0.0003903354, 'Rs': 0.0877697648, 'center_x': 0.5807, 'center_y': 1.8641, 'r_trunc': 1.3766532578454738}, {'alpha_Rs': 0.0012594636, 'Rs': 0.1879249253, 'center_x': 2.659, 'center_y': 0.8367, 'r_trunc': 2.4581423834599323}, {'alpha_Rs': 0.0006551777, 'Rs': 0.0840604899, 'center_x': 1.8621, 'center_y': 0.0605, 'r_trunc': 1.6097060220411954}, {'alpha_Rs': 0.0014206332, 'Rs': 0.166619888, 'center_x': 0.6989, 'center_y': -2.299, 'r_trunc': 2.5201787717350967}, {'alpha_Rs': 0.0003666138, 'Rs': 0.0568469298, 'center_x': -0.1667, 'center_y': -0.3122, 'r_trunc': 1.178367050123896}, {'alpha_Rs': 0.0003193955, 'Rs': 0.0725823003, 'center_x': -2.0618, 'center_y': 0.6129, 'r_trunc': 1.1747042427150425}, {'alpha_Rs': 0.0006374956, 'Rs': 0.1079429196, 'center_x': -2.4521, 'center_y': 0.7725, 'r_trunc': 1.614222818236637}, {'alpha_Rs': 0.0003798813, 'Rs': 0.0523725204, 'center_x': -2.4035, 'center_y': -0.4883, 'r_trunc': 1.130427650262336}, {'alpha_Rs': 0.0003820014, 'Rs': 0.0729656261, 'center_x': 2.7015, 'center_y': -0.8526, 'r_trunc': 1.2156480075681237}, {'alpha_Rs': 0.0004508123, 'Rs': 0.046709992, 'center_x': -0.1602, 'center_y': -2.6676, 'r_trunc': 1.1779041014869958}, {'alpha_Rs': 0.0004005058, 'Rs': 0.0445188528, 'center_x': -2.0365, 'center_y': -0.6846, 'r_trunc': 1.1130243456401627}, {'alpha_Rs': 0.0005003036, 'Rs': 0.0614256645, 'center_x': 2.2938, 'center_y': -0.3118, 'r_trunc': 1.2577861904090346}, {'alpha_Rs': 0.0003156912, 'Rs': 0.0593370845, 'center_x': -0.7052, 'center_y': 1.4587, 'r_trunc': 1.0417039234814776}, {'alpha_Rs': 0.0010226741, 'Rs': 0.1589341864, 'center_x': -0.772, 'center_y': 2.293, 'r_trunc': 1.9617933653453257}, {'alpha_Rs': 0.0004161327, 'Rs': 0.0482592439, 'center_x': 2.1935, 'center_y': -0.6934, 'r_trunc': 1.0733428135078045}, {'alpha_Rs': 0.0003296967, 'Rs': 0.0716936476, 'center_x': -1.6003, 'center_y': 0.6201, 'r_trunc': 1.0310054818579906}, {'alpha_Rs': 0.0004206511, 'Rs': 0.0943321408, 'center_x': 1.0117, 'center_y': -0.1913, 'r_trunc': 1.2000118879607264}, {'alpha_Rs': 0.0017939038, 'Rs': 0.2307283536, 'center_x': 2.2727, 'center_y': 0.4783, 'r_trunc': 2.5583942977261662}, {'alpha_Rs': 0.0012753587, 'Rs': 0.1007653376, 'center_x': 1.1322, 'center_y': 0.3842, 'r_trunc': 1.8913023030187521}, {'alpha_Rs': 0.0004954541, 'Rs': 0.0696898094, 'center_x': 1.5501, 'center_y': -0.8503, 'r_trunc': 1.2051200447482846}, {'alpha_Rs': 0.0004227714, 'Rs': 0.0725599586, 'center_x': -0.1211, 'center_y': 2.0675, 'r_trunc': 1.1412295998309359}, {'alpha_Rs': 0.0004963299, 'Rs': 0.0802359437, 'center_x': 1.6767, 'center_y': 2.1078, 'r_trunc': 1.2416936754867571}, {'alpha_Rs': 0.0003561478, 'Rs': 0.0618550991, 'center_x': -0.3473, 'center_y': 1.4319, 'r_trunc': 1.0004814640480997}, {'alpha_Rs': 0.0002916712, 'Rs': 0.0523637299, 'center_x': -0.5247, 'center_y': -1.0717, 'r_trunc': 0.8928801829621803}, {'alpha_Rs': 0.0009233372, 'Rs': 0.0914023615, 'center_x': -1.163, 'center_y': -1.9452, 'r_trunc': 1.5589031145983683}, {'alpha_Rs': 0.0003599796, 'Rs': 0.0904197897, 'center_x': 1.3258, 'center_y': 0.5945, 'r_trunc': 1.0673574358321967}, {'alpha_Rs': 0.0004670816, 'Rs': 0.1207882697, 'center_x': 2.1211, 'center_y': -2.0906, 'r_trunc': 1.2521838272700543}, {'alpha_Rs': 0.0005754191, 'Rs': 0.0362721206, 'center_x': -1.5387, 'center_y': -0.4295, 'r_trunc': 1.0268504903632545}, {'alpha_Rs': 0.0020649799, 'Rs': 0.2061365236, 'center_x': 1.7427, 'center_y': -1.0115, 'r_trunc': 2.460899735406416}, {'alpha_Rs': 0.0003614664, 'Rs': 0.071283881, 'center_x': 1.5781, 'center_y': -1.6749, 'r_trunc': 0.9919489445503155}, {'alpha_Rs': 0.0006111171, 'Rs': 0.0502923981, 'center_x': 1.9151, 'center_y': -0.5434, 'r_trunc': 1.1325039648232902}, {'alpha_Rs': 0.0010761913, 'Rs': 0.1268792436, 'center_x': -0.4461, 'center_y': 0.8922, 'r_trunc': 1.7222237722561988}, {'alpha_Rs': 0.0003881243, 'Rs': 0.048806964, 'center_x': -2.6658, 'center_y': -0.0325, 'r_trunc': 0.9426234472670669}, {'alpha_Rs': 0.0003057259, 'Rs': 0.0391500121, 'center_x': 0.1106, 'center_y': 0.9382, 'r_trunc': 0.7966006542951343}, {'alpha_Rs': 0.0006275596, 'Rs': 0.0681506901, 'center_x': -0.0008, 'center_y': 0.8194, 'r_trunc': 1.1904763977476072}, {'alpha_Rs': 0.0038629741, 'Rs': 0.2921355886, 'center_x': -1.1409, 'center_y': -0.965, 'r_trunc': 3.297021670898296}, {'alpha_Rs': 0.0005752392, 'Rs': 0.0552118862, 'center_x': -0.7005, 'center_y': -1.3689, 'r_trunc': 1.0715074718124062}, {'alpha_Rs': 0.0002825918, 'Rs': 0.0469103221, 'center_x': -0.0851, 'center_y': 0.5642, 'r_trunc': 0.7827441220161439}, {'alpha_Rs': 0.0004892674, 'Rs': 0.0962778993, 'center_x': 1.3118, 'center_y': 0.4047, 'r_trunc': 1.1265487884107488}, {'alpha_Rs': 0.0003648479, 'Rs': 0.101179124, 'center_x': -1.0914, 'center_y': -1.4002, 'r_trunc': 1.009006607645138}, {'alpha_Rs': 0.0002230087, 'Rs': 0.076593215, 'center_x': -0.0751, 'center_y': -1.4878, 'r_trunc': 0.7842551093658696}, {'alpha_Rs': 0.0011831703, 'Rs': 0.1808794022, 'center_x': 1.3869, 'center_y': 0.6517, 'r_trunc': 1.7696576988063033}, {'alpha_Rs': 0.0003229561, 'Rs': 0.0789866716, 'center_x': 0.7808, 'center_y': 1.2168, 'r_trunc': 0.8943765050690419}, {'alpha_Rs': 0.004734664, 'Rs': 0.2667979079, 'center_x': -1.4135, 'center_y': -0.8527, 'r_trunc': 3.342559445173934}, {'alpha_Rs': 0.0003335405, 'Rs': 0.051699099, 'center_x': 2.3207, 'center_y': -0.6975, 'r_trunc': 0.8321890039566127}, {'alpha_Rs': 0.0002601028, 'Rs': 0.055917321, 'center_x': -1.1835, 'center_y': 0.4893, 'r_trunc': 0.7662132850754036}, {'alpha_Rs': 0.0016470072, 'Rs': 0.1500040524, 'center_x': -1.3632, 'center_y': -1.6373, 'r_trunc': 1.952902816610175}, {'alpha_Rs': 0.0003278975, 'Rs': 0.0451962578, 'center_x': -0.3449, 'center_y': -2.0499, 'r_trunc': 0.803327169494112}, {'alpha_Rs': 0.0011939516, 'Rs': 0.1525219879, 'center_x': -0.5635, 'center_y': -1.2289, 'r_trunc': 1.680601918989456}, {'alpha_Rs': 0.0003497275, 'Rs': 0.1215017777, 'center_x': 0.6827, 'center_y': 1.6428, 'r_trunc': 0.9743636041507714}, {'alpha_Rs': 0.0004497888, 'Rs': 0.0927792366, 'center_x': 0.7341, 'center_y': 1.002, 'r_trunc': 1.0297675575640433}, {'alpha_Rs': 0.0009037711, 'Rs': 0.0912664307, 'center_x': 1.3996, 'center_y': 0.0429, 'r_trunc': 1.3576596009657051}, {'alpha_Rs': 0.0003498104, 'Rs': 0.0474235766, 'center_x': 0.8047, 'center_y': -0.4378, 'r_trunc': 0.8132576082744387}, {'alpha_Rs': 0.0004027376, 'Rs': 0.0575986274, 'center_x': 1.1038, 'center_y': 0.7471, 'r_trunc': 0.8760423182108509}, {'alpha_Rs': 0.0006667672, 'Rs': 0.0762413711, 'center_x': 0.4458, 'center_y': 0.2659, 'r_trunc': 1.133858099085985}, {'alpha_Rs': 0.0002976828, 'Rs': 0.04813563, 'center_x': -0.5766, 'center_y': 0.0772, 'r_trunc': 0.7329490634078117}, {'alpha_Rs': 0.0007373998, 'Rs': 0.1269344188, 'center_x': 0.9501, 'center_y': -1.2018, 'r_trunc': 1.2773721472653252}, {'alpha_Rs': 0.0023503591, 'Rs': 0.134376444, 'center_x': 0.9633, 'center_y': -1.4108, 'r_trunc': 2.0566997279828034}, {'alpha_Rs': 0.0003079363, 'Rs': 0.0560147763, 'center_x': -0.4515, 'center_y': -1.2474, 'r_trunc': 0.7664700747476476}, {'alpha_Rs': 0.0003306434, 'Rs': 0.0915699806, 'center_x': 0.0529, 'center_y': -0.3359, 'r_trunc': 0.8670620052497784}, {'alpha_Rs': 0.0002973744, 'Rs': 0.0578318641, 'center_x': 1.5512, 'center_y': -0.6629, 'r_trunc': 0.7607739257383671}, {'alpha_Rs': 0.0011953328, 'Rs': 0.1273469949, 'center_x': -0.3652, 'center_y': -1.2146, 'r_trunc': 1.5225639486615288}, {'alpha_Rs': 0.0002314219, 'Rs': 0.0490298583, 'center_x': 1.6406, 'center_y': -0.5117, 'r_trunc': 0.639765227378878}, {'alpha_Rs': 0.0003930422, 'Rs': 0.1005770277, 'center_x': -0.9829, 'center_y': -1.405, 'r_trunc': 0.8923979035107116}, {'alpha_Rs': 0.0007388989, 'Rs': 0.1173056787, 'center_x': -0.8453, 'center_y': 1.0478, 'r_trunc': 1.1878914037644075}, {'alpha_Rs': 0.0003478176, 'Rs': 0.0644935396, 'center_x': 0.9173, 'center_y': 0.9618, 'r_trunc': 0.7808821611546655}, {'alpha_Rs': 0.0002419674, 'Rs': 0.0470642651, 'center_x': -1.8038, 'center_y': -0.4298, 'r_trunc': 0.62303608732325}, {'alpha_Rs': 0.0004407546, 'Rs': 0.0719704877, 'center_x': -0.7963, 'center_y': 1.0413, 'r_trunc': 0.8480910441800453}, {'alpha_Rs': 0.0003787428, 'Rs': 0.0863175972, 'center_x': 0.7944, 'center_y': 1.6062, 'r_trunc': 0.8260143732118531}, {'alpha_Rs': 0.0002384879, 'Rs': 0.0429470671, 'center_x': 0.0293, 'center_y': 1.5247, 'r_trunc': 0.5885783982270687}, {'alpha_Rs': 0.0024044669, 'Rs': 0.1579366561, 'center_x': -0.0451, 'center_y': 0.0495, 'r_trunc': 1.9257630060748612}, {'alpha_Rs': 0.0002778848, 'Rs': 0.0429860825, 'center_x': -0.9851, 'center_y': -0.2594, 'r_trunc': 0.6253883727760255}, {'alpha_Rs': 0.0003316255, 'Rs': 0.0570927987, 'center_x': -0.3729, 'center_y': -1.1589, 'r_trunc': 0.7007835396345338}, {'alpha_Rs': 0.0005603589, 'Rs': 0.0812835737, 'center_x': -1.3389, 'center_y': 0.5692, 'r_trunc': 0.9276641788967934}, {'alpha_Rs': 0.0002983591, 'Rs': 0.0515517459, 'center_x': 0.3123, 'center_y': 1.3525, 'r_trunc': 0.6489233881907106}, {'alpha_Rs': 0.0002797787, 'Rs': 0.0529017321, 'center_x': -0.4105, 'center_y': -0.1033, 'r_trunc': 0.6358242036222369}, {'alpha_Rs': 0.0005124369, 'Rs': 0.0724438049, 'center_x': -0.1808, 'center_y': 0.815, 'r_trunc': 0.8513041581186135}, {'alpha_Rs': 0.000297594, 'Rs': 0.0692935317, 'center_x': 0.7981, 'center_y': 0.3071, 'r_trunc': 0.6698974573511621}, {'alpha_Rs': 0.0006267584, 'Rs': 0.0905536095, 'center_x': 1.4985, 'center_y': -0.0293, 'r_trunc': 0.952783401269078}, {'alpha_Rs': 0.0002031141, 'Rs': 0.0599021838, 'center_x': -0.8574, 'center_y': -0.1316, 'r_trunc': 0.5581820228179499}, {'alpha_Rs': 0.0002367957, 'Rs': 0.0517538326, 'center_x': -0.1332, 'center_y': 0.4166, 'r_trunc': 0.5773210512244074}, {'alpha_Rs': 0.0003440494, 'Rs': 0.0584624609, 'center_x': -1.2705, 'center_y': -0.2911, 'r_trunc': 0.6790875975450472}, {'alpha_Rs': 0.0002165927, 'Rs': 0.0428322647, 'center_x': 0.2114, 'center_y': 1.1874, 'r_trunc': 0.5301590224393375}, {'alpha_Rs': 0.0002733181, 'Rs': 0.0628362809, 'center_x': 0.6552, 'center_y': -0.6389, 'r_trunc': 0.621357623568613}, {'alpha_Rs': 0.0004637929, 'Rs': 0.0822144988, 'center_x': 0.9514, 'center_y': 0.3585, 'r_trunc': 0.8022211264966491}, {'alpha_Rs': 0.0001587679, 'Rs': 0.046383425, 'center_x': 0.1725, 'center_y': -0.0931, 'r_trunc': 0.46198114915607275}, {'alpha_Rs': 0.0002226004, 'Rs': 0.0589194589, 'center_x': 0.4684, 'center_y': -1.0183, 'r_trunc': 0.5544668526796299}, {'alpha_Rs': 0.0006655525, 'Rs': 0.1185585178, 'center_x': -0.3126, 'center_y': 0.8677, 'r_trunc': 0.9862496749200306}, {'alpha_Rs': 0.0001591363, 'Rs': 0.060535397, 'center_x': 0.8711, 'center_y': 0.1815, 'r_trunc': 0.4860523820397469}, {'alpha_Rs': 0.0003977704, 'Rs': 0.0679179737, 'center_x': 1.0504, 'center_y': 0.6, 'r_trunc': 0.7144394553584993}, {'alpha_Rs': 0.0003381291, 'Rs': 0.0759305888, 'center_x': 0.1135, 'center_y': 0.2243, 'r_trunc': 0.6837090825859852}, {'alpha_Rs': 0.0003884391, 'Rs': 0.0678950713, 'center_x': 0.8634, 'center_y': -0.8364, 'r_trunc': 0.7026199609151133}, {'alpha_Rs': 0.0004637543, 'Rs': 0.0639564775, 'center_x': -0.7889, 'center_y': -0.7822, 'r_trunc': 0.7405356625079789}, {'alpha_Rs': 0.0001570859, 'Rs': 0.0638705768, 'center_x': 0.5647, 'center_y': 0.8566, 'r_trunc': 0.47796453019952595}, {'alpha_Rs': 0.0001724741, 'Rs': 0.0624376882, 'center_x': 0.1501, 'center_y': 0.6547, 'r_trunc': 0.4921125514228067}, {'alpha_Rs': 0.0010130081, 'Rs': 0.1652378134, 'center_x': -0.3813, 'center_y': -0.6292, 'r_trunc': 1.211566393680103}, {'alpha_Rs': 0.0002969452, 'Rs': 0.0907172577, 'center_x': 0.2956, 'center_y': -1.0971, 'r_trunc': 0.6575714732368012}, {'alpha_Rs': 0.0001389604, 'Rs': 0.0399312227, 'center_x': -0.6304, 'center_y': 0.3068, 'r_trunc': 0.41409466262669925}, {'alpha_Rs': 0.0001549234, 'Rs': 0.0550895203, 'center_x': -0.6499, 'center_y': -0.4023, 'r_trunc': 0.46031916541140416}, {'alpha_Rs': 0.0006011412, 'Rs': 0.100863836, 'center_x': -0.044, 'center_y': 0.4953, 'r_trunc': 0.8907291474962327}, {'alpha_Rs': 0.0001264947, 'Rs': 0.0411129043, 'center_x': 0.0312, 'center_y': 0.7827, 'r_trunc': 0.39939622560301685}, {'alpha_Rs': 0.0001999815, 'Rs': 0.0464205799, 'center_x': -0.4013, 'center_y': -0.2209, 'r_trunc': 0.4915854277119219}, {'alpha_Rs': 0.0005216723, 'Rs': 0.0887195588, 'center_x': -0.298, 'center_y': -0.0808, 'r_trunc': 0.8181525245331184}, {'alpha_Rs': 0.0002216604, 'Rs': 0.0645291695, 'center_x': 0.7807, 'center_y': 0.3259, 'r_trunc': 0.5432007821008092}, {'alpha_Rs': 0.0002741297, 'Rs': 0.0874054319, 'center_x': -0.257, 'center_y': 0.8165, 'r_trunc': 0.6296005843208781}, {'alpha_Rs': 0.0004543641, 'Rs': 0.0950469289, 'center_x': -0.6159, 'center_y': -0.5898, 'r_trunc': 0.7856884134035239}, {'alpha_Rs': 0.0003099829, 'Rs': 0.044568608, 'center_x': 0.2974, 'center_y': 0.1299, 'r_trunc': 0.5810843561562103}, {'alpha_Rs': 7.61536e-05, 'Rs': 0.0509054167, 'center_x': -0.0895, 'center_y': 0.7697, 'r_trunc': 0.3416492767678286}, {'alpha_Rs': 8.50614e-05, 'Rs': 0.0620869975, 'center_x': -0.6761, 'center_y': 0.4013, 'r_trunc': 0.3732713846368264}, {'alpha_Rs': 0.0002248412, 'Rs': 0.1148225436, 'center_x': -0.7993, 'center_y': -0.2072, 'r_trunc': 0.6266595661540614}, {'alpha_Rs': 9.0765e-05, 'Rs': 0.0525326592, 'center_x': 0.1334, 'center_y': 0.0473, 'r_trunc': 0.3810941185643343}, {'alpha_Rs': 8.93904e-05, 'Rs': 0.061030348, 'center_x': -0.7458, 'center_y': 0.126, 'r_trunc': 0.3890185059363484}, {'alpha_Rs': 0.000165409, 'Rs': 0.0710228249, 'center_x': 0.7145, 'center_y': -0.1443, 'r_trunc': 0.5146021085948714}, {'alpha_Rs': 0.0003511418, 'Rs': 0.1388707083, 'center_x': -0.4238, 'center_y': -0.6924, 'r_trunc': 0.8019613260721594}, {'alpha_Rs': 7.17377e-05, 'Rs': 0.0739571904, 'center_x': 0.1546, 'center_y': 0.2206, 'r_trunc': 0.3722369968149118}, {'alpha_Rs': 7.97717e-05, 'Rs': 0.0547238868, 'center_x': 0.3724, 'center_y': 0.1542, 'r_trunc': 0.37675468023140496}, {'alpha_Rs': 0.0001242395, 'Rs': 0.0578096293, 'center_x': 0.0737, 'center_y': 0.2362, 'r_trunc': 0.46587353675453175}, {'alpha_Rs': 0.000314138, 'Rs': 0.1463964023, 'center_x': 0.5654, 'center_y': -0.4659, 'r_trunc': 0.8273875357345389}, {'alpha_Rs': 0.0001022523, 'Rs': 0.0628080017, 'center_x': -0.0421, 'center_y': 0.3488, 'r_trunc': 0.44886768934123733}, {'alpha_Rs': 7.11976e-05, 'Rs': 0.0559761596, 'center_x': -0.0943, 'center_y': -0.6441, 'r_trunc': 0.3913181392920985}, {'alpha_Rs': 3.67197e-05, 'Rs': 0.049078333, 'center_x': 0.4257, 'center_y': 0.5314, 'r_trunc': 0.2912036855600792}, {'alpha_Rs': 5.36329e-05, 'Rs': 0.0648135347, 'center_x': -0.2412, 'center_y': -0.2433, 'r_trunc': 0.3572627520649342}, {'alpha_Rs': 0.0002064304, 'Rs': 0.183129373, 'center_x': -0.4057, 'center_y': -0.0865, 'r_trunc': 0.7412618844484722}, {'alpha_Rs': 5.55031e-05, 'Rs': 0.0452190913, 'center_x': -0.0223, 'center_y': 0.717, 'r_trunc': 0.3398267733514794}, {'alpha_Rs': 0.0001175852, 'Rs': 0.0707541573, 'center_x': 0.3562, 'center_y': 0.3008, 'r_trunc': 0.5208510495638388}, {'alpha_Rs': 0.0001189437, 'Rs': 0.098508745, 'center_x': -0.0837, 'center_y': -0.2087, 'r_trunc': 0.5823862063278636}, {'alpha_Rs': 0.0001081069, 'Rs': 0.0851718605, 'center_x': -0.3483, 'center_y': -0.2976, 'r_trunc': 0.5457433498894447}, {'alpha_Rs': 2.1396e-05, 'Rs': 0.058593027, 'center_x': 0.5895, 'center_y': 0.0711, 'r_trunc': 0.2773661189533556}, {'alpha_Rs': 0.0002164022, 'Rs': 0.1960544945, 'center_x': -0.0857, 'center_y': -0.0902, 'r_trunc': 0.8890369426180054}, {'alpha_Rs': 1.77089e-05, 'Rs': 0.0425850131, 'center_x': -0.621, 'center_y': 0.1173, 'r_trunc': 0.29083528509060336}, {'alpha_Rs': 1.88094e-05, 'Rs': 0.060686472, 'center_x': -0.0893, 'center_y': 0.2789, 'r_trunc': 0.31730852076108074}, {'alpha_Rs': 1.99226e-05, 'Rs': 0.0899478174, 'center_x': -0.1297, 'center_y': 0.0002, 'r_trunc': 0.40416500284064344}, {'alpha_Rs': 0.0005034972, 'Rs': 0.0726824607, 'center_x': 0.041, 'center_y': -1.4713, 'r_trunc': 1.1691085291328753}, {'alpha_Rs': 0.0006673465, 'Rs': 0.1093159681, 'center_x': 0.8947, 'center_y': -2.703, 'r_trunc': 1.4204303016459117}, {'alpha_Rs': 0.0003606792, 'Rs': 0.0563544946, 'center_x': -0.9006, 'center_y': 0.4628, 'r_trunc': 0.9715260508552664}, {'kappa': -0.00021141705188609068, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00019975609300397192, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00026389888999853547, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0003295884408731741, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00039219591797490255, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0004503784591509656, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0005035336217445898, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0005513171927656625, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0005935577388135738, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006301776333684802, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006611737140776373, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006866007983003078, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00033929478690298735, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006541773309817455, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.000667430401860718, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006757104821530783, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006792025975230716, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006781275715498218, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006726965521935198, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0006631395415416216, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.000649679833945531, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.000632553269606176, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00061197649777989, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0005881711620423357, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0005613574838708159, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0005317456197032759, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0004995483925227172, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00046495153945702355, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.000428151937958839, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00038932651902638324, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0003486498761439437, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00030628993186561734, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0002624004635837817, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.00021713182174876747, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0001706254506885919, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -0.0001230184585093296, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -7.443579585184943e-05, 'ra_0': 0.0, 'dec_0': 0.0}, {'kappa': -2.500104377714091e-05, 'ra_0': 0.0, 'dec_0': 0.0}, {'alpha_Rs': -0.039648250568173324, 'Rs': 15.34433327566908, 'center_x': 0.0, 'center_y': 0.0, 'r_core': 3.83608331891727}]

        self.lens_model_list_macro = ['EPL', 'SHEAR']
        self.redshift_list_macro = [self.zlens] * 2
        self.kwargs_macro = [{'theta_E': 1.0, 'center_x': 0.0, 'center_y': 0.0, 'e1':-0.1, 'e2': 0.2, 'gamma': 2.05},
                       {'gamma1': 0.04, 'gamma2': 0.08}]
        cosmology = Background()
        self.cosmo = cosmology.cosmo
        self.lens_model = LensModel(self.lens_model_list_macro+self.lens_model_list_halos,
                                    lens_redshift_list=self.redshift_list_macro+self.redshift_list_halos,
                                    multi_plane=True, z_source=self.zsource, cosmo=self.cosmo)
        self.extension = LensModelExtensions(self.lens_model)
        self.source_x, self.source_y = 0.05, -0.065
        self.x_image, self.y_image = [ 1.03258609, -1.00426198, -0.56318898,  0.03452012], [-0.34599331, -0.08994027, -0.80946196,  0.87432157]
        self.source_size_pc = 45.
        mag = self.extension.magnification_finite_adaptive(self.x_image, self.y_image,
                                                           self.source_x, self.source_y,
                                                           self.kwargs_macro+self.kwargs_halos, self.source_size_pc,
                                                           self.zsource, cosmo=self.cosmo)
        self.flux_ratios = mag[1:]/mag[0]

    def test_kwargs_shift(self):

        for i in range(0, 4):
            model = MultiScaleModel(self.x_image[i], self.y_image[i], self.source_x, self.source_y,
                                      self.lens_model_list_halos,
                                      self.redshift_list_halos, self.kwargs_halos, self.zlens, self.zsource, self.cosmo)
            lensmodel, kwargs_shift = model.lensmodel_shift()
            source_x, source_y = lensmodel.ray_shooting(self.x_image[i], self.y_image[i], kwargs_shift)
            npt.assert_almost_equal(source_x, self.source_x)
            npt.assert_almost_equal(source_y, self.source_y)

    def test_solve_kwargs_arc(self):

        diff = 0.075

        multi_image_model = MultiImageModel(self.x_image, self.y_image, self.source_x, self.source_y,
                                            self.lens_model_list_halos, self.redshift_list_halos, self.kwargs_halos,
                                            self.zlens, self.zsource, self.cosmo)
        kwargs_full_list, _ = multi_image_model.solve_kwargs_arc_from_kwargs(self.lens_model,
                                                                             self.kwargs_macro+self.kwargs_halos,
                                                                             diff)
        mags = []
        for i in range(0, 4):
            curved_arc_true = self.extension.curved_arc_estimate(self.x_image[i], self.y_image[i], self.kwargs_macro+self.kwargs_halos,
                                                                 smoothing=diff, smoothing_3rd=diff)
            model = MultiScaleModel(self.x_image[i], self.y_image[i], self.source_x, self.source_y, self.lens_model_list_halos,
                                      self.redshift_list_halos, self.kwargs_halos, self.zlens, self.zsource, self.cosmo)
            kwargs_curved_arc, kwargs_full, penalty_final = model.solve_kwargs_arc(curved_arc_true, diff)
            lens_model_arc = model.lens_model
            extension_arc = LensModelExtensions(lens_model_arc)
            curved_arc_model = extension_arc.curved_arc_estimate(self.x_image[i], self.y_image[i], kwargs_full,
                                                                 smoothing=diff, smoothing_3rd=diff)
            curved_arc_model_multi_image = extension_arc.curved_arc_estimate(self.x_image[i], self.y_image[i], kwargs_full_list[i],
                                                                 smoothing=diff, smoothing_3rd=diff)
            for kw in ['radial_stretch', 'tangential_stretch', 'direction', 'curvature']:
                npt.assert_almost_equal(curved_arc_true[kw], curved_arc_model[kw], 6)
                npt.assert_almost_equal(curved_arc_true[kw], curved_arc_model_multi_image[kw], 6)
            mag = extension_arc.magnification_finite_adaptive([self.x_image[i]], [self.y_image[i]],
                                                           self.source_x, self.source_y,
                                                           kwargs_full_list[i], self.source_size_pc,
                                                           self.zsource, cosmo=self.cosmo)
            mags.append(float(mag))
        flux_ratios = np.array(mags)[1:]/mags[0]

        # accurate to within 1/2 percent
        for fr_true, fr_model in zip(self.flux_ratios, flux_ratios):
            error = abs(1 - fr_model/fr_true)
            npt.assert_array_less(error, 0.005)

    def time_kwargs_arc(self):

        # Nelder-mead (5 min) accurate to 9 decimals
        # Powell (3.1 min) faster than nelder-mead accurate to 9 decimals
        # L-BFGS-B (2.74 min) accurate to 6 decimals
        # CG not accurate to 6 decimals
        # BFGS not accurate to 6 decimals
        # Newton-CG jacobian required

        for method in ['nelder-mead', 'Powell']:
            t0 = time()
            diff = 0.075
            multi_image_model = MultiImageModel(self.x_image, self.y_image, self.source_x, self.source_y,
                                                self.lens_model_list_halos, self.redshift_list_halos, self.kwargs_halos,
                                                self.zlens, self.zsource, self.cosmo)
            multi_image_model.set_minimization_function(method)
            kwargs_full_list, _ = multi_image_model.solve_kwargs_arc_from_kwargs(self.lens_model,
                                                                                 self.kwargs_macro + self.kwargs_halos,
                                                                                 diff)

            for i in range(0, 4):
                curved_arc_true = self.extension.curved_arc_estimate(self.x_image[i], self.y_image[i],
                                                                     self.kwargs_macro + self.kwargs_halos,
                                                                     smoothing=diff, smoothing_3rd=diff)
                model = MultiScaleModel(self.x_image[i], self.y_image[i], self.source_x, self.source_y,
                                        self.lens_model_list_halos,
                                        self.redshift_list_halos, self.kwargs_halos, self.zlens, self.zsource, self.cosmo)
                kwargs_curved_arc, kwargs_full, penalty_final = model.solve_kwargs_arc(curved_arc_true, diff)
                lens_model_arc = model.lens_model
                extension_arc = LensModelExtensions(lens_model_arc)
                curved_arc_model = extension_arc.curved_arc_estimate(self.x_image[i], self.y_image[i], kwargs_full,
                                                                     smoothing=diff, smoothing_3rd=diff)
                curved_arc_model_multi_image = extension_arc.curved_arc_estimate(self.x_image[i], self.y_image[i],
                                                                                 kwargs_full_list[i],
                                                                                 smoothing=diff, smoothing_3rd=diff)
                for kw in ['radial_stretch', 'tangential_stretch', 'direction', 'curvature']:
                    npt.assert_almost_equal(curved_arc_true[kw], curved_arc_model[kw], 7)
                    npt.assert_almost_equal(curved_arc_true[kw], curved_arc_model_multi_image[kw], 7)
            tend = time()
            print('method: ', method)
            print('time ellapsed (min): ', (tend - t0)/60)

t = TestRubato()
t.setup()
t.time_kwargs_arc()
#
# if __name__ == '__main__':
#     pytest.main()
